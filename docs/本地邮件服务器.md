# 本地邮件服务器配置

## 概述

项目提供了两个本地邮件服务器用于开发调试：

1. **MailHog** - 简单易用的邮件捕获工具
2. **Mailpit** - 现代化的邮件服务器（推荐，支持SMTP+IMAP）

## 快速开始

### 1. 启动邮件服务器

```bash
# 启动所有服务
docker-compose up -d

# 或只启动Mailpit（推荐）
docker-compose up -d mailpit

# 或只启动MailHog
docker-compose up -d mailhog
```

### 2. 访问Web UI

- **Mailpit**: http://localhost:8026
- **MailHog**: http://localhost:8025

### 3. 查看日志

```bash
# 查看Mailpit日志
docker-compose logs -f mailpit

# 查看MailHog日志
docker-compose logs -f mailhog
```

### 4. 停止服务

```bash
# 停止所有服务
docker-compose down

# 停止并删除数据
docker-compose down -v
```

## Mailpit 配置（推荐）

### 连接信息

**SMTP 配置**:
```javascript
{
  host: 'localhost',
  port: 1026,
  secure: false,
  auth: {
    user: 'test@example.com',  // 任意邮箱地址
    pass: 'any-password'        // 任意密码
  }
}
```

**IMAP 配置**:
```javascript
{
  host: 'localhost',
  port: 1143,
  secure: false,
  auth: {
    user: 'test@example.com',  // 任意邮箱地址
    pass: 'any-password'        // 任意密码
  },
  folder: 'INBOX'
}
```

### 特性

- ✅ 支持 SMTP 和 IMAP 协议
- ✅ 现代化的 Web UI
- ✅ 支持搜索和过滤
- ✅ 支持附件预览
- ✅ API 接口
- ✅ 数据持久化

### Web UI 功能

1. **查看邮件列表** - 所有收到的邮件
2. **搜索邮件** - 按主题、发件人、收件人搜索
3. **预览HTML邮件** - 实时预览HTML内容
4. **查看原始邮件** - 查看完整的邮件源码
5. **下载附件** - 直接下载邮件附件
6. **删除邮件** - 清理测试邮件

## MailHog 配置

### 连接信息

**SMTP 配置**:
```javascript
{
  host: 'localhost',
  port: 1025,
  secure: false,
  // MailHog 不需要认证
}
```

### 特性

- ✅ 简单易用
- ✅ 自动捕获所有邮件
- ✅ Web UI 查看
- ✅ 无需配置

### 限制

- ❌ 不支持 IMAP（只能发送，不能读取）
- ❌ 功能相对简单

## 在应用中使用

### 开发环境配置

在应用的设置界面中，配置以下参数：

**使用 Mailpit（推荐）**:

```
SMTP配置:
  主机: localhost
  端口: 1026
  安全连接: 否
  用户名: test@example.com
  密码: 123456

IMAP配置:
  主机: localhost
  端口: 1143
  安全连接: 否
  用户名: test@example.com
  密码: 123456
  文件夹: INBOX
```

**使用 MailHog**:

```
SMTP配置:
  主机: localhost
  端口: 1025
  安全连接: 否
  （无需用户名和密码）
```

## 测试流程

### 1. 测试SMTP发送

```javascript
// 在应用中发送一封测试邮件
const smtp = new SmtpClient();
await smtp.initialize({
  host: 'localhost',
  port: 1026,
  secure: false,
  auth: {
    user: 'test@example.com',
    pass: '123456'
  }
});

await smtp.sendEmail({
  to: 'recipient@example.com',
  subject: 'Test Email',
  html: '<h1>Hello from Email Digest!</h1>'
});
```

然后访问 http://localhost:8026 查看收到的邮件。

### 2. 测试IMAP读取

```javascript
// 在应用中读取邮件
const imap = new ImapClient();
await imap.initialize({
  host: 'localhost',
  port: 1143,
  secure: false,
  auth: {
    user: 'test@example.com',
    pass: '123456'
  },
  folder: 'INBOX'
});

const messages = await imap.fetchDigests();
console.log('收到', messages.length, '封邮件');
```

### 3. 完整流程测试

1. 启动 Mailpit
2. 在应用中捕获一个网页
3. 应用会发送文摘到 Mailpit
4. 在 Web UI 中查看发送的邮件
5. 使用应用的同步功能，从 Mailpit 读取邮件
6. 验证文摘是否正确保存到本地

## 故障排除

### 无法连接到SMTP

1. 确认Docker容器正在运行：
   ```bash
   docker-compose ps
   ```

2. 检查端口是否被占用：
   ```bash
   lsof -i :1026
   ```

3. 查看容器日志：
   ```bash
   docker-compose logs mailpit
   ```

### 收不到邮件

1. 检查SMTP配置是否正确
2. 查看应用日志中的错误信息
3. 在 Web UI 中查看是否有邮件到达

### IMAP连接失败

1. 确认使用的是 Mailpit（MailHog 不支持IMAP）
2. 检查端口1143是否可访问
3. 确认认证信息（任意用户名/密码都可以）

## API 接口

Mailpit 提供了 REST API 用于自动化测试：

```bash
# 获取所有邮件
curl http://localhost:8026/api/v1/messages

# 获取特定邮件
curl http://localhost:8026/api/v1/message/{id}

# 删除所有邮件
curl -X DELETE http://localhost:8026/api/v1/messages
```

## 生产环境

⚠️ **警告**: 这些邮件服务器仅用于开发调试，不要在生产环境中使用！

生产环境应该使用：
- Gmail
- Outlook
- QQ邮箱
- 163邮箱
- 自建邮件服务器（如 Postfix + Dovecot）

## 参考资料

- [Mailpit GitHub](https://github.com/axllent/mailpit)
- [MailHog GitHub](https://github.com/mailhog/MailHog)
- [Docker Compose 文档](https://docs.docker.com/compose/)
